<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Héroes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- CSS de Quill -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="menu-acordeon.css">
    <link rel="stylesheet" href="Hoja_Personajes.css">
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
</head>

<body class="bg-dark">
    <!--<div class="menu">
        <iframe src="menu.html" frameborder="0" class="menu-frame"></iframe>
        <button id="toggleMenu">☰</button>
    </div>-->
    <div class="d-flex gap-2 mb-3">
        <button onclick="verSlots()" class="btn btn-info">Ver Slots</button>
        <button id="exportar" class="btn btn-success">Exportar a JSON</button>
        <button id="btnImportar" class="btn btn-secondary">Importar JSON</button>
        <input type="file" id="importar" accept="application/json" class="d-none">
        <button class="btn btn-secondary w-100 mb-1" onclick="nuevoHeroeSlot()">Nuevo Héroe</button>

    </div>
    <div class="container" style="max-width:100%;">
        <h1 class="mb-4 text-center">Gestión de Héroes - 4 Slots</h1>



        <!-- Panel de 4 héroes -->
        <div class="row" id="heroSlots"></div>

        <h2 class="mb-3 mt-4">Lista de héroes guardados</h2>
        <div id="lista" class="row gy-3"></div>
    </div>

   <script>
    let db;
    let cambiosPendientes = { 1: false, 2: false, 3: false, 4: false };
    const quills = {};

    // --- NUEVA FUNCIÓN DEBOUNCE ---
    // Esta función retrasa la ejecución de otra función.
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    const baseActualIds = ['Nivel', 'Suerte', 'Energía', 'Vida', 'det', 'hc', 'hd', 'esquiva', 'fcerrad', 'trueque', 'curar', 'alquimia', 'plegaria', 'aArcanas', 'percep', 'superviv', 'cordura', 'peso'];
    const slashPairs = [['fue', 'bd'], ['con', 'an'], ['des', 'm'], ['sab', 'mana'], ['m1', 'm2']];
    const especiales = ['Nivel', 'Suerte', 'Energía']; // atributos solo con base
    const atributosBase = ['FUE', 'DES', 'CON', 'SAB', 'DET'];

    // Inicializar IndexedDB
    const request = indexedDB.open("PersonajesDB", 2);

    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains('personajes')) {
            db.createObjectStore('personajes', { keyPath: 'id', autoIncrement: true });
        }
        if (!db.objectStoreNames.contains('slots')) {
            db.createObjectStore('slots', { keyPath: 'slot' });
        }
    };

    request.onsuccess = (e) => {
        db = e.target.result;
        generarSlots();
        mostrarPersonajes();
        restaurarSlots();
    };

    function generarSlots() {
        const container = document.getElementById('heroSlots');
        container.innerHTML = '';
        for (let i = 1; i <= 4; i++) {
            const col = document.createElement('div');
            col.className = 'col-12 col-sm-6 col-lg-3 mb-3';
            col.innerHTML = `
                <div class="flip-card" id="slot${i}">
                    <div class="flip-card-inner">
                        <div class="flip-card-front p-3 shadow-sm hero-card">
                             <button class="btn btn-sm btn-dark flip-btn">&cularr;</button>
                             <h5 class="hero-card-title" id="nombreSlotDisplay${i}">Héroe ${i}</h5>
                             <input type="text" placeholder="Nombre" class="form-control mb-1" id="nombre${i}">
                             <div class="row g-2 mb-1">
                               <div class="col-6"><input type="text" placeholder="Raza" class="form-control" id="raza${i}"></div>
                               <div class="col-6"><input type="text" placeholder="Profesión" class="form-control" id="profesion${i}"></div>
                             </div>
                             <div class="row g-2 mb-2" id="atributos${i}"></div>
                             <img src="" alt="Preview" class="img-preview" id="preview${i}" style="display:none;">
                             <input type="file" accept="image/*" class="form-control mb-1" id="imagen${i}">
                             <button class="btn btn-primary w-100 mb-1" onclick="guardarSlot(${i})">Guardar Slot</button>
                        </div>
                        <div class="flip-card-back p-3 shadow-sm hero-card">
                            <button class="btn btn-sm btn-dark flip-btn">&cularr;</button>
                            <h5>Notas</h5>
                            <div id="notas-slot${i}" class="notas-quill"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(col);

            quills[i] = new Quill(`#notas-slot${i}`, {
                theme: 'snow',
                placeholder: 'Escribe tus NOTAS aquí...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'image']
                    ]
                }
            });

            // Auto-guardado para Quill (editor de notas)
            const debouncedQuillSave = debounce(() => guardarSlotAuto(i), 1500);
            quills[i].on('text-change', debouncedQuillSave);


            // Generar campos de atributos dinámicamente
            const attrContainer = document.getElementById(`atributos${i}`);
            baseActualIds.forEach(id => {
                if (especiales.includes(id)) {
                    attrContainer.innerHTML += `
                        <div class="col-4 mb-1">
                            <label class="form-label">${id}</label>
                            <input type="number" id="${id}base${i}" class="form-control" placeholder="Base">
                        </div>`;
                } else {
                     attrContainer.innerHTML += `
                        <div class="col-6 mb-1">
                            <label class="form-label">${id}</label>
                            <div class="input-group">
                                <input type="number" id="${id}base${i}" class="form-control" placeholder="Base">
                                <input type="number" id="${id}actual${i}" class="form-control" placeholder="Actual">
                            </div>
                        </div>`;
                }

                if (id === 'Energía') {
                     attrContainer.innerHTML += `<div class="col-12 mb-2">
                        <div class="d-flex justify-content-center text-center gap-2">
                        ${atributosBase.map(attr => `
                            <div class="flex-fill">
                                <label class="form-label">${attr.toUpperCase()}</label>
                                <input type="number" id="${attr.toLowerCase()}base${i}" class="form-control text-center" placeholder="${attr.toUpperCase()}">
                            </div>
                        `).join('')}
                        </div>
                    </div>`;
                }
            });

            slashPairs.forEach(pair => {
                attrContainer.innerHTML += `
                    <div class="col-6 mb-1">
                        <label class="form-label">${pair[0]}/${pair[1]}</label>
                        <div class="input-group">
                            <input type="number" id="${pair[0]}${i}" class="form-control" placeholder="${pair[0]}">
                            <span class="input-group-text">/</span>
                            <input type="number" id="${pair[1]}${i}" class="form-control" placeholder="${pair[1]}">
                        </div>
                    </div>`;
            });
            
            // --- MODIFICADO ---
            // Activamos el auto guardado para este slot
            activarAutoGuardadoSlot(i);
        }
    }

    function obtenerAtributosSlot(slot) {
        let atributos = {};
        baseActualIds.forEach(id => {
            if (especiales.includes(id)) {
                atributos[id] = { base: parseInt(document.getElementById(`${id}base${slot}`).value) || 0 };
            } else {
                atributos[id] = {
                    base: parseInt(document.getElementById(`${id}base${slot}`).value) || 0,
                    actual: parseInt(document.getElementById(`${id}actual${slot}`).value) || 0
                };
            }
        });
        atributosBase.forEach(id => {
            atributos[id] = { base: parseInt(document.getElementById(`${id.toLowerCase()}base${slot}`).value) || 0 };
        });
        slashPairs.forEach(pair => {
            atributos[pair[0]] = {
                base: parseInt(document.getElementById(`${pair[0]}${slot}`).value) || 0,
                actual: parseInt(document.getElementById(`${pair[1]}${slot}`).value) || 0,
            };
        });
        return atributos;
    }
    
    function rellenarAtributosSlot(slot, atributos) {
        baseActualIds.forEach(id => {
            if (atributos[id]) {
                const baseElem = document.getElementById(`${id}base${slot}`);
                if (baseElem) baseElem.value = atributos[id].base ?? 0;

                if (!especiales.includes(id)) {
                    const actualElem = document.getElementById(`${id}actual${slot}`);
                    if (actualElem) actualElem.value = atributos[id].actual ?? 0;
                }
            }
        });
        atributosBase.forEach(id => {
            if (atributos[id]) {
                const baseElem = document.getElementById(`${id.toLowerCase()}base${slot}`);
                if (baseElem) baseElem.value = atributos[id].base ?? 0;
            }
        });
        slashPairs.forEach(pair => {
            if (atributos[pair[0]]) {
                const a = document.getElementById(`${pair[0]}${slot}`);
                const b = document.getElementById(`${pair[1]}${slot}`);
                if (a) a.value = atributos[pair[0]].base ?? 0;
                if (b) b.value = atributos[pair[0]].actual ?? 0;
            }
        });
    }

    // Guardar un slot en IndexedDB (botón manual)
    function guardarSlot(slot) {
        const nombre = document.getElementById(`nombre${slot}`).value.trim();
        const raza = document.getElementById(`raza${slot}`).value.trim();
        const profesion = document.getElementById(`profesion${slot}`).value.trim();
        const imagen = document.getElementById(`preview${slot}`).src;
        const atributos = obtenerAtributosSlot(slot);
        const notas = quills[slot].root.innerHTML;

        if (!nombre || !raza || !profesion || !imagen.startsWith('data:image')) {
            alert('Completa todos los campos (Nombre, Raza, Profesión) y asigna una imagen.');
            return;
        }

        const tx = db.transaction('personajes', 'readwrite');
        const store = tx.objectStore('personajes');
        
        const personajeData = { nombre, raza, profesion, imagen, atributos, notas };
        
        // Comprobar si ya existe un personaje con ese nombre para actualizarlo
        const index = store.index('nombre'); // Asumiendo que tienes un índice por nombre
        const request = index.get(nombre);

        request.onsuccess = (e) => {
             const existing = e.target.result;
             if (existing) {
                // Actualizar personaje existente
                personajeData.id = existing.id;
                const updateRequest = store.put(personajeData);
                updateRequest.onsuccess = () => {
                    asignarPersonajeASlot(slot, personajeData.id);
                    cambiosPendientes[slot] = false;
                    mostrarPersonajes();
                };
             } else {
                // Añadir nuevo personaje
                const addRequest = store.add(personajeData);
                addRequest.onsuccess = (ev) => {
                    asignarPersonajeASlot(slot, ev.target.result);
                    cambiosPendientes[slot] = false;
                    mostrarPersonajes();
                };
             }
        };

        tx.oncomplete = () => {
            console.log(`Slot ${slot} guardado.`);
        };
    }
    
    // --- FUNCIÓN DE AUTO-GUARDADO MODIFICADA ---
    function activarAutoGuardadoSlot(slot) {
        // Creamos una única función debounced para este slot
        const debouncedSave = debounce(() => guardarSlotAuto(slot), 1500); // Espera 1.5s

        // Función para añadir listeners a un campo
        const addListeners = (elementId) => {
            const input = document.getElementById(elementId);
            if (input) {
                input.addEventListener('input', debouncedSave);
            }
        };

        // Campos de atributos base/actual
        baseActualIds.forEach(id => {
            addListeners(`${id}base${slot}`);
            if (!especiales.includes(id)) {
                addListeners(`${id}actual${slot}`);
            }
        });

        // Atributos principales (FUE, DES, etc.)
        atributosBase.forEach(attr => {
            addListeners(`${attr.toLowerCase()}base${slot}`);
        });

        // Campos dobles (fue/bd, etc.)
        slashPairs.forEach(pair => {
            addListeners(`${pair[0]}${slot}`);
            addListeners(`${pair[1]}${slot}`);
        });

        // Campo de imagen
        const imgInput = document.getElementById(`imagen${slot}`);
        if (imgInput) {
            imgInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const preview = document.getElementById(`preview${slot}`);
                        preview.src = event.target.result;
                        preview.style.display = 'block';
                        debouncedSave(); // Llama al guardado debounced
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // NO AÑADIMOS LISTENERS PARA nombre, raza y profesion
    }


    function guardarSlotAuto(slot) {
        console.log(`Iniciando autoguardado para slot ${slot}...`);
        const nombre = document.getElementById(`nombre${slot}`).value.trim();
        const raza = document.getElementById(`raza${slot}`).value.trim();
        const profesion = document.getElementById(`profesion${slot}`).value.trim();

        // No guardar si los campos básicos no están completos.
        if (!nombre || !raza || !profesion) {
            console.log("Autoguardado cancelado: Faltan nombre, raza o profesión.");
            return;
        }
        
        // Marcar que hay cambios pendientes
        cambiosPendientes[slot] = true;
        console.log("Cambios pendientes marcados para slot:", slot);

        // Llamamos a la función de guardado principal.
        // La lógica de si es un personaje nuevo o existente se maneja ahí.
        guardarSlot(slot);
    }
    
    function asignarPersonajeASlot(slot, personajeId) {
        const tx = db.transaction('slots', 'readwrite');
        tx.objectStore('slots').put({ slot: slot, personajeId: personajeId });
    }

    function restaurarSlots() {
        const tx = db.transaction('slots', 'readonly');
        tx.objectStore('slots').getAll().onsuccess = (e) => {
            e.target.result.forEach(asignacion => {
                cargarEnSlot(asignacion.slot, asignacion.personajeId);
            });
        };
    }

    function mostrarPersonajes() {
        const tx = db.transaction('personajes', 'readonly');
        const store = tx.objectStore('personajes');
        store.getAll().onsuccess = (e) => {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            e.target.result.forEach(p => {
                lista.innerHTML += `
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${p.nombre}</h5>
                                <p class="card-text">Raza: ${p.raza}<br>Profesión: ${p.profesion}</p>
                                <img src="${p.imagen}" alt="${p.nombre}" class="img-fluid rounded mb-3">
                                <div class="d-flex gap-2 mt-auto">
                                    <button class="btn btn-warning" onclick="cargarEnSlotPrompt(${p.id})">Cargar</button>
                                    <button class="btn btn-danger" onclick="eliminarPersonaje(${p.id})">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
        };
    }

    function cargarEnSlotPrompt(id) {
        let slot = prompt("¿En qué slot cargar? (1-4)");
        slot = parseInt(slot);
        if (slot >= 1 && slot <= 4) {
            cargarEnSlot(slot, id);
        } else {
            alert("Slot inválido.");
        }
    }
    
    function cargarEnSlot(slot, id) {
        const tx = db.transaction('personajes', 'readonly');
        const store = tx.objectStore('personajes');
        store.get(id).onsuccess = (e) => {
            const p = e.target.result;
            if (p) {
                document.getElementById(`nombre${slot}`).value = p.nombre;
                document.getElementById(`raza${slot}`).value = p.raza;
                document.getElementById(`profesion${slot}`).value = p.profesion;
                const preview = document.getElementById(`preview${slot}`);
                preview.src = p.imagen;
                preview.style.display = p.imagen ? 'block' : 'none';
                
                rellenarAtributosSlot(slot, p.atributos);
                
                if (p.notas) {
                   quills[slot].root.innerHTML = p.notas;
                } else {
                   quills[slot].root.innerHTML = '';
                }

                document.getElementById(`nombreSlotDisplay${slot}`).textContent = p.nombre || `Héroe ${slot}`;
                
                cambiosPendientes[slot] = false;
                asignarPersonajeASlot(slot, p.id);
            }
        };
    }

    function eliminarPersonaje(id) {
        if (confirm("¿Eliminar este personaje?")) {
            const tx = db.transaction('personajes', 'readwrite');
            tx.objectStore('personajes').delete(id);
            tx.oncomplete = mostrarPersonajes;
        }
    }
    
    document.getElementById('exportar').addEventListener('click', () => {
        const tx = db.transaction('personajes', 'readonly');
        tx.objectStore('personajes').getAll().onsuccess = (e) => {
            const personajes = e.target.result;
            const blob = new Blob([JSON.stringify(personajes, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'personajes.json';
            a.click();
        };
    });

    document.getElementById('btnImportar').addEventListener('click', () => document.getElementById('importar').click());
    document.getElementById('importar').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                const tx = db.transaction('personajes', 'readwrite');
                const store = tx.objectStore('personajes');
                data.forEach(p => store.put(p)); // put para sobreescribir si existe
                tx.oncomplete = mostrarPersonajes;
            } catch (err) {
                alert("Error al importar el JSON.");
            }
        };
        reader.readAsText(file);
    });

    // Actualizar título de la tarjeta con el nombre
    for (let i = 1; i <= 4; i++) {
        const nombreInput = document.getElementById(`nombre${i}`);
        const nombreDisplay = document.getElementById(`nombreSlotDisplay${i}`);
        nombreInput.addEventListener('input', (e) => {
            nombreDisplay.textContent = e.target.value || `Héroe ${i}`;
        });
    }
    
    // Flip card
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('flip-btn')) {
            const card = e.target.closest('.flip-card');
            if (card) {
                card.classList.toggle('flipped');
            }
        }
    });

</script>


    <!-- JS de Quill -->
</body>



</html>